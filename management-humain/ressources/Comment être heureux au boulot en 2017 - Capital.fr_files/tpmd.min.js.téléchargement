var PmdTrackerConsole=function(){this.constructor="PmdTrackerConsole",this.hasDebug=!1;var a=this;this.debug=function(a){if("undefined"==typeof a)return!0===this.hasDebug||"undefined"!=typeof window.sessionStorage&&("true"==window.sessionStorage.getItem("pmd.debug")||"on"==window.sessionStorage.getItem("pmd.debug"));this.hasDebug="on"==a||"true"==a;var b=this.hasDebug?"on":"off";return"undefined"!=typeof window.sessionStorage&&window.sessionStorage.setItem("pmd.debug",b),this.hasDebug},"undefined"!=typeof console&&["error","info","log","exception","group","groupEnd","table"].forEach(function(b){Object.defineProperty(a,b,{value:function(){this.debug()&&console[b].apply(null,arguments)}})})},$pmdconsole=new PmdTrackerConsole;Object.defineProperty(Object.prototype,"mergeProperties",{enumerable:!1,value:function(a){if("undefined"==typeof a)return this;try{var b=this;return Object.getOwnPropertyNames(a).forEach(function(c){var d=a[c];"object"!=typeof d?b[c]=d:"object"!=typeof b[c]?b[c]=d:b[c]=b[c].mergeProperties(d)}),this}catch(c){}}}),Object.defineProperty(Object.prototype,"toQueryString",{enumerable:!1,value:function(a){var b=this,c=[];return Object.getOwnPropertyNames(b).forEach(function(d){var e=b[d],f="object"==typeof e||"undefined"!=typeof a?"".concat(a,"[",d,"]"):d;"object"==typeof e?c.push(e.toQueryString(d)):c.push(encodeURIComponent(f)+"="+encodeURIComponent(e))}),c.join("&")}}),Object.defineProperty(Object.prototype,"toJson",{enumerable:!1,value:function(){return JSON.stringify(this)}}),String.prototype.applyPattern=function(a){var b=new RegExp(a),c=b.exec(this);return c&&c.length>0?c=decodeURIComponent(c[1]):null};var PmdTrackerData=function(a){this.site=document.location.host,this.url=document.location.href,this.user="",this.datetime=new Date,this.referrer=document.referrer,this.user_agent=navigator.userAgent,this.resolution_height=screen.height,this.resolution_width=screen.width,this.pixel_density=window.devicePixelRatio,this.keywords=[],this.category="",this.template="",this.is_responsive="",this.is_user_connected="",Object.seal(this),this.mergeProperties(a)},PmdTrackerStorage=function(a){this.settings={size:1e3},Object.seal(this.settings),this.settings.mergeProperties(a)};PmdTrackerStorage.prototype={retrieve:function(a){$pmdconsole.group("PmdTrackerStorage::retrieve",arguments);var b=this.retrieveFromLocalStorage(a);return b||(b=this.retrieveFromSessionStorage(a),b||(b=this.retrieveFromCookie(a))),$pmdconsole.groupEnd(),b},retrieveFromLocalStorage:function(a){$pmdconsole.info("PmdTrackerStorage::retrieveFromLocalStorage",arguments);var b=null;return"undefined"!=typeof window.localStorage&&(b=window.localStorage.getItem(a)),b},retrieveFromSessionStorage:function(a){$pmdconsole.info("PmdTrackerStorage::retrieveFromSessionStorage",arguments);var b=null;return"undefined"!=typeof window.sessionStorage&&(b=window.sessionStorage.getItem(a)),b},retrieveFromCookie:function(a){return $pmdconsole.info("PmdTrackerStorage::retrieveFromCookie",arguments),document.cookie.toString().applyPattern(a+"=([^;]+)")},store:function(a,b){return $pmdconsole.group("PmdTrackerStorage::store",arguments),this.storeInLocalStorage(a,b),this.storeInSessionStorage(a,b),this.storeInCookie(a,b),$pmdconsole.groupEnd(),this},storeInLocalStorage:function(a,b){return $pmdconsole.group("PmdTrackerStorage::storeInLocalStorage",arguments),"undefined"!=typeof window.localStorage?("undefined"==typeof b?window.localStorage.removeItem(a):window.localStorage.setItem(a,b),$pmdconsole.log(" => OK")):$pmdconsole.log(" => SKIP"),$pmdconsole.groupEnd(),this},storeInSessionStorage:function(a,b){return $pmdconsole.group("PmdTrackerStorage::storeInSessionStorage",arguments),"undefined"!=typeof window.sessionStorage?("undefined"==typeof b?window.sessionStorage.removeItem(a):window.sessionStorage.setItem(a,b),$pmdconsole.info(" => OK")):$pmdconsole.info(" => SKIP"),$pmdconsole.groupEnd(),this},storeInCookie:function(a,b){$pmdconsole.info("PmdTrackerStorage::storeInCookie",arguments);var c="";if(null!==b){var d=new Date;d.setTime(d.getTime()+2592e6),c="; expires="+d.toGMTString()}document.cookie=a+"="+b+c+"; path=/"},remove:function(a){return $pmdconsole.group("PmdTrackerStorage::remove",arguments),this.storeInLocalStorage(a,null),this.storeInSessionStorage(a,null),this.storeInCookie(a,null),$pmdconsole.groupEnd(),this},getLocalHistory:function(a){$pmdconsole.group("PmdTrackerStorage::getLocalHistory",arguments);var b=this.retrieveFromLocalStorage(a);return b?(b=JSON.parse(b),(!b||!b instanceof Array)&&(b=[])):b=[],$pmdconsole.groupEnd(),b},archive:function(a,b){$pmdconsole.group("PmdTrackerStorage::archive",arguments);var c=this.getLocalHistory(a);if(c.length>this.settings.size){$pmdconsole.info("Max history size is reached : clean half");var d=Math.floor(c.length/2);c=c.slice(-d)}return c.push(b),this.storeInLocalStorage(a,JSON.stringify(c)),$pmdconsole.groupEnd(),this},history:function(a){$pmdconsole.group("PmdTrackerStorage::history",arguments);var b=this.getLocalHistory(a);return $pmdconsole.debug()?$pmdconsole.table(b):"undefined"!=typeof console&&console.table(b),$pmdconsole.groupEnd(),this}};var PmdTracker=function(a,b){this.constructor="PmdTracker",this.settings={trackerHost:"track.tra.pmdstatic.net",nocache:!1,version:"master"},Object.seal(this.settings),this.setSettings(a),this.data=new PmdTrackerData,Object.seal(this.data),this.setData(b),this.iframe=null,this.iframeInitialized=!1,this.init()};PmdTracker.prototype={init:function(){var a=this;window.addEventListener("hashchange",function(b){a.onHashChange(b)},!1),window.addEventListener("message",function(b){try{var c=JSON.parse(b.data)}catch(d){return}"pmdIframeInitialized"==c.type&&(a.onHashChange(b),a.iframeShowHistoryToolbar(!0)),"showHistoryToolbar"==c.type&&a.showHistoryToolbar(c.rawHistory)})},getTrackerHost:function(){return document.location.protocol.concat("//",this.settings.trackerHost)},setSettings:function(a){return $pmdconsole.info("PmdTracker::setSettings",arguments),this.settings.mergeProperties(a),this},setData:function(a){return $pmdconsole.info("PmdTracker::setData",arguments),this.data.mergeProperties(a),this},send:function(){return $pmdconsole.group("PmdTracker::send",arguments),this.postMessage(["send","archive"]),$pmdconsole.groupEnd(),this},getMessage:function(a,b){$pmdconsole.info("PmdTracker::getMessage",arguments),"object"!=typeof a&&(a=[a]);var c={action:a.toJson(),injector:"pmd"};return("undefined"==typeof b||!1!==b)&&(c.data=this.data.toJson()),c.toQueryString()},initIframe:function(){var a=this;$pmdconsole.info("PmdTracker::initIframe",arguments);var b=!0===this.settings.nocache?"?nocache=true":"";return this.iframe=document.createElement("iframe"),this.iframe.id="pmdTrackerIframe",this.iframe.style.display="none",this.iframe.onload=function(){window.postMessage(JSON.stringify({type:"pmdIframeInitialized"}),"*"),a.iframeInitialized=!0},this.iframe.src=this.getTrackerHost().concat("/iframe.html",b,"#","debug=",$pmdconsole.debug(),"&","version=",this.settings.version,"&",this.getMessage(["init"])),$pmdconsole.log("inject iframe",this.iframe.src),document.body.appendChild(this.iframe),this},history:function(){return $pmdconsole.group("PmdTracker::history",arguments),this.postMessage("history"),$pmdconsole.groupEnd(),this},getRawHistory:function(){return $pmdconsole.group("PmdTracker::getRawHistory",arguments),this.postMessage("getRawHistory"),$pmdconsole.groupEnd(),this},flushHistory:function(){return $pmdconsole.group("PmdTracker::flushHistory",arguments),this.postMessage("flushHistory"),$pmdconsole.groupEnd(),this},showComponentsVersion:function(){return $pmdconsole.group("PmdTracker::showComponentsVersion",arguments),this.postMessage("showComponentsVersion"),$pmdconsole.groupEnd(),this},postMessage:function(a,b){var c=this;this.iframeInitialized?this.iframe.contentWindow.postMessage(this.getMessage(a,b),this.getTrackerHost()):(this.initIframe(),window.addEventListener("message",function(d){try{var e=JSON.parse(d.data)}catch(f){return}"pmdIframeInitialized"==e.type&&c.iframe.contentWindow.postMessage(c.getMessage(a,b),c.getTrackerHost())}))},iframeShowHistoryToolbar:function(a){return"undefined"==typeof a&&(a=!1),$pmdconsole.group("PmdTracker::showHistoryToolbar",arguments),this.postMessage(a===!0?"showHistoryToolbarWithCheckCookie":"showHistoryToolbar"),$pmdconsole.groupEnd(),this},iframeHideHistoryToolbar:function(){return $pmdconsole.group("PmdTracker::hideHistoryToolbar",arguments),this.postMessage("hideHistoryToolbar"),$pmdconsole.groupEnd(),this},hideHistoryToolbar:function(){return 0==document.querySelectorAll(".trackHistoryToolbar").length?this:(document.querySelector(".trackHistoryToolbar").style.display="none",this)},showHistoryToolbar:function(a){var b=this;if(document.querySelectorAll(".trackHistoryToolbar").length>0)return document.querySelector(".trackHistoryToolbar").style.display="block",this;if("undefined"==typeof this.toolbarCssInitialized){var c=document.createElement("link");c.setAttribute("rel","stylesheet"),c.setAttribute("type","text/css"),c.setAttribute("href",b.getTrackerHost()+"/showHistoryToolbar.min.css"),document.head.appendChild(c),this.toolbarCssInitialized=!0}var d="http://placehold.it/110x50",e=document.createElement("div");e.classList.add("trackHistoryToolbar");var f=Math.round(document.body.clientWidth/150)-2;f>10&&(f=10),a.reverse().splice(f,a.length);for(var g=(new Array,f);g>=0;g--)if("undefined"!=typeof a[g]){var h=this.createThumbnail(a[g].url,d,"Loading content",a[g]);h.classList.add("trackHistoryToolbar_thumbnail--"+g),e.appendChild(h),function(c){jQuery.ajax({url:a[c].url,success:function(a){var d=/<title>(.*)<\/title>/,e=d.exec(a),f="Titre inconnu";e&&(f=e[1]);var g=/meta property="og:image" content="(.*?)"/,h=g.exec(a),i="http://placehold.it/110x50";h&&(i=h[1],i=b.resizeImage(i));var j=document.querySelector(".trackHistoryToolbar_thumbnail--"+c+" .trackHistoryToolbar_thumbnailImg");j.setAttribute("src",i);var k=document.querySelector(".trackHistoryToolbar_thumbnail--"+c+" .trackHistoryToolbar_thumbnailTitle");k.innerHTML=f},error:function(b){var e=document.querySelector(".trackHistoryToolbar_thumbnail--"+c+" .trackHistoryToolbar_thumbnailImg");e.setAttribute("src",d);var f=document.querySelector(".trackHistoryToolbar_thumbnail--"+c+" .trackHistoryToolbar_thumbnailTitle");f.innerHTML=a[c].url},async:!0})}(g)}var i=document.querySelector("title")?document.querySelector("title").innerHTML:"Undefined title",j=document.querySelector('meta[property="og:image"]')?this.resizeImage(document.querySelector('meta[property="og:image"]').getAttribute("content")):d,k=this.createThumbnail(this.data.url,j,i,this.data);k.classList.add("trackHistoryToolbar_thumbnail--current"),e.appendChild(k);var l=document.createElement("div");l.classList.add("trackHistoryToolbar_separator"),e.appendChild(l);var h=b.createThumbnail("#",d,"Proposition de contenu 1");e.appendChild(h);var h=b.createThumbnail("#",d,"Proposition de contenu 2");e.appendChild(h),document.body.appendChild(e)},createThumbnail:function(a,b,c,d){var e=document.createElement("div");e.classList.add("trackHistoryToolbar_containerImg");var f=document.createElement("p");f.classList.add("trackHistoryToolbar_thumbnailTitle"),f.innerHTML=c;var g=document.createElement("a");g.setAttribute("href",a);var h=document.createElement("img");h.setAttribute("src",b),h.classList.add("trackHistoryToolbar_thumbnailImg"),g.appendChild(h),e.appendChild(g);var i=document.createElement("div");if(i.classList.add("trackHistoryToolbar_thumbnail"),i.appendChild(e),i.appendChild(f),"object"==typeof d){var j=document.createElement("ul");j.classList.add("trackHistoryToolbar_thumbnailOtherInformations");var k=document.createElement("li");k.classList.add("trackHistoryToolbar_thumbnailKeywords"),k.innerHTML=d.keywords.join(", ");var l=document.createElement("li");l.classList.add("trackHistoryToolbar_thumbnailCategory"),l.innerHTML=d.category;var m=document.createElement("li");m.classList.add("trackHistoryToolbar_thumbnailReferrer"),m.innerHTML=d.referrer,j.appendChild(k),j.appendChild(l),j.appendChild(m),i.appendChild(j)}return i},resizeImage:function(a){return"http://img.tra.pmdstatic.net/fit/"+encodeURIComponent(a).replace(/\./g,".2E").replace(/%/g,".")+"/110x50/quality/100img-service-tester.jpg"},onHashChange:function(a){"#pmdShowHistoryToolbar"==document.location.hash&&this.iframeShowHistoryToolbar(!1),"#pmdHideHistoryToolbar"==document.location.hash&&(this.iframeHideHistoryToolbar(),this.hideHistoryToolbar())}};